<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reviews - Movie Vault</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Montserrat:wght@400;700;800&family=Poppins:wght@400;700&family=Roboto:wght@400;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="style/watchlist.css">
</head>

<body>
  <div class="container">
    <div class="header-section">
      <h1>⭐ <span class="vault">MOVIE VAULT</span> - Reviews</h1>
      <div class="user-info">
        <span id="userDisplay"></span>
        <button id="logoutBtn" class="logout-btn">Logout</button>
      </div>
    </div>

    <div class="nav-links">
      <a href="movies.html" class="nav-link">← Back</a>
      <a href="watchlist.html" class="nav-link">Watchlist</a>
    </div>

    <div class="add-movie-section">
      <button id="addReviewBtn" class="add-movie-btn">
        <span class="btn-icon">⭐</span>
        <span class="btn-text">Add New Review</span>
      </button>
    </div>

    <div id="reviewCardsContainer" class="movie-cards-container"></div>
    <div id="emptyState" class="empty-state" style="display: none;">
      <h3>⭐ No Reviews Yet</h3>
      <p>Share your thoughts by adding your first review!</p>
    </div>
  </div>

  <!-- Modal for Add/Edit Review -->
  <div id="reviewModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Add Review</h2>
        <span class="close">&times;</span>
      </div>

      <form id="reviewForm" class="movie-form">
        <input type="hidden" id="reviewId" name="reviewId" value="">

        <div class="form-group">
          <label for="movieTitle">Movie Title</label>
          <input type="text" id="movieTitle" name="title" placeholder="Enter movie title" required>
        </div>

        <div class="form-group">
          <label for="movieDescription">Description (optional)</label>
          <textarea id="movieDescription" name="description" rows="3" placeholder="Short description"></textarea>
        </div>

        <div class="form-group">
          <label for="movieGenres">Genres (optional)</label>
          <div class="genre-selector">
            <div class="selected-genres" id="selectedGenresDisplay">
              <span class="placeholder">Click to select genres...</span>
            </div>
            <div class="genre-dropdown" id="genreDropdown">
              <div class="genre-option" data-value="Action">Action</div>
              <div class="genre-option" data-value="Adventure">Adventure</div>
              <div class="genre-option" data-value="Animation">Animation</div>
              <div class="genre-option" data-value="Biography">Biography</div>
              <div class="genre-option" data-value="Comedy">Comedy</div>
              <div class="genre-option" data-value="Crime">Crime</div>
              <div class="genre-option" data-value="Documentary">Documentary</div>
              <div class="genre-option" data-value="Drama">Drama</div>
              <div class="genre-option" data-value="Family">Family</div>
              <div class="genre-option" data-value="Fantasy">Fantasy</div>
              <div class="genre-option" data-value="History">History</div>
              <div class="genre-option" data-value="Horror">Horror</div>
              <div class="genre-option" data-value="Musical">Musical</div>
              <div class="genre-option" data-value="Mystery">Mystery</div>
              <div class="genre-option" data-value="Romance">Romance</div>
              <div class="genre-option" data-value="Sci-Fi">Sci-Fi</div>
              <div class="genre-option" data-value="Sports">Sports</div>
              <div class="genre-option" data-value="Thriller">Thriller</div>
              <div class="genre-option" data-value="War">War</div>
              <div class="genre-option" data-value="Western">Western</div>
              <div class="genre-option" data-value="Superhero">Superhero</div>
              <div class="genre-option" data-value="Slice of Life">Slice of Life</div>
              <div class="genre-option" data-value="Psychological">Psychological</div>
              <div class="genre-option" data-value="Suspense">Suspense</div>
              <div class="genre-option" data-value="Political">Political</div>
              <div class="genre-option" data-value="Period Drama">Period Drama</div>
              <div class="genre-option" data-value="Experimental">Experimental</div>
              <div class="genre-option" data-value="Short Films">Short Films</div>
              <div class="genre-option" data-value="Reality">Reality</div>
              <div class="genre-option" data-value="Talk Show">Talk Show</div>
              <div class="genre-option" data-value="Game Show">Game Show</div>
              <div class="genre-option" data-value="Action-Comedy">Action-Comedy</div>
              <div class="genre-option" data-value="Black Comedy">Black Comedy</div>
              <div class="genre-option" data-value="Dark Fantasy">Dark Fantasy</div>
              <div class="genre-option" data-value="Paranormal">Paranormal</div>
              <div class="genre-option" data-value="Teen">Teen</div>
              <div class="genre-option" data-value="Coming-of-Age">Coming-of-Age</div>
              <div class="genre-option" data-value="Martial Arts">Martial Arts</div>
              <div class="genre-option" data-value="Spy/Espionage">Spy/Espionage</div>
              <div class="genre-option" data-value="Heist">Heist</div>
              <div class="genre-option" data-value="Survival">Survival</div>
              <div class="genre-option" data-value="Disaster">Disaster</div>
              <div class="genre-option" data-value="Cyberpunk">Cyberpunk</div>
              <div class="genre-option" data-value="Steampunk">Steampunk</div>
              <div class="genre-option" data-value="Post-Apocalyptic">Post-Apocalyptic</div>
              <div class="genre-option" data-value="Dystopian">Dystopian</div>
              <div class="genre-option" data-value="Space Opera">Space Opera</div>
              <div class="genre-option" data-value="Gothic">Gothic</div>
              <div class="genre-option" data-value="Tragedy">Tragedy</div>
              <div class="genre-option" data-value="Legal/Courtroom">Legal/Courtroom</div>
              <div class="genre-option" data-value="Medical">Medical</div>
              <div class="genre-option" data-value="Military">Military</div>
              <div class="genre-option" data-value="Mythology">Mythology</div>
              <div class="genre-option" data-value="Folklore">Folklore</div>
              <div class="genre-option" data-value="Historical Fiction">Historical Fiction</div>
              <div class="genre-option" data-value="Anthology">Anthology</div>
              <div class="genre-option" data-value="Romantic Comedy (Rom-Com)">Romantic Comedy (Rom-Com)</div>
              <div class="genre-option" data-value="Drama-Comedy (Dramedy)">Drama-Comedy (Dramedy)</div>
              <div class="genre-option" data-value="Detective/Whodunit">Detective/Whodunit</div>
              <div class="genre-option" data-value="Educational">Educational</div>
              <div class="genre-option" data-value="Stand-Up Comedy">Stand-Up Comedy</div>
              <div class="genre-option" data-value="Travel">Travel</div>
              <div class="genre-option" data-value="Cooking/Food">Cooking/Food</div>
              <div class="genre-option" data-value="Music/Concert">Music/Concert</div>
              <div class="genre-option" data-value="Dance">Dance</div>
              <div class="genre-option" data-value="Idol/Pop Culture">Idol/Pop Culture</div>
              <div class="genre-option" data-value="Ecchi">Ecchi</div>
              <div class="genre-option" data-value="Mecha">Mecha</div>
              <div class="genre-option" data-value="Isekai">Isekai</div>
              <div class="genre-option" data-value="Shonen">Shonen</div>
              <div class="genre-option" data-value="Shojo">Shojo</div>
              <div class="genre-option" data-value="Seinen">Seinen</div>
              <div class="genre-option" data-value="Josei">Josei</div>
            </div>
          </div>
          <input type="hidden" id="selectedGenres" name="selectedGenres">
        </div>

        <div class="form-group">
          <label for="ottPlatforms">OTT Platforms (optional)</label>
          <div class="ott-selector">
            <div class="selected-ott" id="selectedOTTDisplay">
              <span class="placeholder">Click to select platforms...</span>
            </div>
            <div class="ott-dropdown" id="ottDropdown">
              <div class="ott-option" data-value="Netflix">Netflix</div>
              <div class="ott-option" data-value="Amazon Prime Video">Amazon Prime Video</div>
              <div class="ott-option" data-value="Disney+">Disney+</div>
              <div class="ott-option" data-value="YouTube Premium">YouTube Premium</div>
              <div class="ott-option" data-value="JioCinema / Disney+ Hotstar">JioCinema / Disney+ Hotstar</div>
              <div class="ott-option" data-value="WeTV">WeTV</div>
              <div class="ott-option" data-value="Max (HBO Max)">Max (HBO Max)</div>
              <div class="ott-option" data-value="iQiyi">iQiyi</div>
              <div class="ott-option" data-value="Hulu">Hulu</div>
              <div class="ott-option" data-value="Paramount+">Paramount+</div>
              <div class="ott-option" data-value="SonyLIV">SonyLIV</div>
              <div class="ott-option" data-value="ZEE5">ZEE5</div>
              <div class="ott-option" data-value="MX Player">MX Player</div>
              <div class="ott-option" data-value="Apple TV+">Apple TV+</div>
              <div class="ott-option" data-value="Peacock">Peacock</div>
              <div class="ott-option" data-value="Roku / The Roku Channel">Roku / The Roku Channel</div>
              <div class="ott-option" data-value="Pluto TV">Pluto TV</div>
              <div class="ott-option" data-value="Plex">Plex</div>
              <div class="ott-option" data-value="Twitch">Twitch</div>
              <div class="ott-option" data-value="TikTok TV">TikTok TV</div>
              <div class="ott-option" data-value="Hoichoi">Hoichoi</div>
              <div class="ott-option" data-value="Eros Now">Eros Now</div>
              <div class="ott-option" data-value="ALTBalaji (ALTT)">ALTBalaji (ALTT)</div>
              <div class="ott-option" data-value="Voot">Voot</div>
              <div class="ott-option" data-value="Aha">Aha</div>
              <div class="ott-option" data-value="Sun NXT">Sun NXT</div>
              <div class="ott-option" data-value="Discovery+">Discovery+</div>
              <div class="ott-option" data-value="DocuBay">DocuBay</div>
              <div class="ott-option" data-value="ManoramaMAX">ManoramaMAX</div>
              <div class="ott-option" data-value="ShemarooMe">ShemarooMe</div>
              <div class="ott-option" data-value="Hungama Play">Hungama Play</div>
              <div class="ott-option" data-value="Lionsgate Play">Lionsgate Play</div>
              <div class="ott-option" data-value="Apple iTunes Movies">Apple iTunes Movies</div>
              <div class="ott-option" data-value="Google TV (Movies & Shows)">Google TV (Movies & Shows)</div>
              <div class="ott-option" data-value="Crunchyroll">Crunchyroll</div>
              <div class="ott-option" data-value="HIDIVE">HIDIVE</div>
              <div class="ott-option" data-value="RetroCrush">RetroCrush</div>
              <div class="ott-option" data-value="Anime Box">Anime Box</div>
              <div class="ott-option" data-value="d-anime Store">d-anime Store</div>
              <div class="ott-option" data-value="Abema">Abema</div>
              <div class="ott-option" data-value="Bilibili">Bilibili</div>
              <div class="ott-option" data-value="Kanopy">Kanopy</div>
              <div class="ott-option" data-value="Anime Times">Anime Times</div>
            </div>
          </div>

          <input type="hidden" id="selectedOTT" name="selectedOTT">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="releaseYear">Release Year</label>
            <input type="number" id="releaseYear" name="releaseYear" placeholder="2024" min="1800" max="2100" required>
          </div>
          <div class="form-group">
            <label for="imdbRating">IMDb Rating (0-10)</label>
            <input type="number" id="imdbRating" name="imdbRating" placeholder="0" min="0" max="10" step="0.1">
          </div>
        </div>

        <div class="form-group">
          <label>Your Rating (0-10)</label>
          <div class="rating-stars" id="reviewRatingStars">
            <button type="button" class="star" data-value="0">☆</button>
            <button type="button" class="star" data-value="1">★</button>
            <button type="button" class="star" data-value="2">★</button>
            <button type="button" class="star" data-value="3">★</button>
            <button type="button" class="star" data-value="4">★</button>
            <button type="button" class="star" data-value="5">★</button>
            <button type="button" class="star" data-value="6">★</button>
            <button type="button" class="star" data-value="7">★</button>
            <button type="button" class="star" data-value="8">★</button>
            <button type="button" class="star" data-value="9">★</button>
            <button type="button" class="star" data-value="10">★</button>
          </div>
          <input type="hidden" id="reviewRatingValue" value="0">
        </div>

        <div class="form-group">
          <label for="posterImage">Poster Image URL (optional)</label>
          <input type="url" id="posterImage" name="posterImage" placeholder="https://example.com/poster.jpg">
        </div>

        <div class="form-group">
          <label for="reviewText">Your Review</label>
          <textarea id="reviewText" name="reviewText" rows="4" placeholder="Share your thoughts..."></textarea>
          <div class="helper-text" id="reviewCounter">0/500</div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="reviewPros">Pros (optional)</label>
            <textarea id="reviewPros" rows="3" placeholder="What did you like?"></textarea>
          </div>
          <div class="form-group">
            <label for="reviewCons">Cons (optional)</label>
            <textarea id="reviewCons" rows="3" placeholder="What could be better?"></textarea>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label><input type="checkbox" id="isSpoiler"> Contains spoilers</label>
          </div>
          <div class="form-group">
            <label>Recommend?</label>
            <select id="recommended">
              <option value="true" selected>Yes</option>
              <option value="false">No</option>
            </select>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" id="cancelBtn" class="btn-secondary">Cancel</button>
          <button type="submit" class="btn-primary" id="submitBtn">Add Review</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Spoiler Warning Modal -->
  <div id="spoilerWarningModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>⚠️ Spoiler Warning</h2>
        <span class="close close-spoiler-warning">&times;</span>
      </div>
      <div class="modal-body">
        <p>This review contains spoilers that may reveal important plot details.</p>
        <p>Are you sure you want to continue reading?</p>
      </div>
      <div class="modal-actions">
        <button id="continueReadingBtn" class="btn-primary">Continue Reading</button>
        <button id="cancelReadingBtn" class="btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Review Details Modal -->
  <div id="reviewDetailsModal" class="modal">
    <div class="modal-content movie-details-modal">
      <div class="modal-header">
        <h2 id="detailsReviewTitle"></h2>
        <span class="close close-review-details">&times;</span>
      </div>
      <div class="movie-details-content">
        <div class="movie-details-poster">
          <img id="detailsReviewPoster" src="" alt="Movie Poster">
        </div>
        <div class="movie-details-info">
          <div class="details-row">
            <span class="details-label">Release Year:</span>
            <span id="detailsReviewYear"></span>
          </div>
          <div class="details-row">
            <span class="details-label">Your Rating:</span>
            <span id="detailsReviewStars"></span>
          </div>
          <div class="details-row">
            <span class="details-label">IMDb Rating:</span>
            <span id="detailsReviewIMDb"></span>
          </div>
          <div class="details-row">
            <span class="details-label">Genres:</span>
            <div id="detailsReviewGenres" class="details-genres"></div>
          </div>
          <div class="details-row">
            <span class="details-label">OTT Platforms:</span>
            <div id="detailsReviewOTT" class="details-ott"></div>
          </div>
          <div class="details-row full-width">
            <span class="details-label">Description:</span>
            <p id="detailsReviewDescription"></p>
          </div>
          <div class="details-row full-width" id="detailsReviewTextRow" style="display:none;">
            <span class="details-label">Your Review:</span>
            <p id="detailsReviewText"></p>
          </div>
          <div class="details-row full-width" id="detailsProsConsRow" style="display:none;">
            <span class="details-label">Notes:</span>
            <div>
              <div id="detailsPros" style="margin-bottom:8px;"></div>
              <div id="detailsCons"></div>
              <div id="detailsFlags" style="margin-top:8px;"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="movie-details-actions">
        <button id="editReviewFromDetailsBtn" class="btn-primary">Edit Review</button>
        <button id="closeReviewDetailsBtn" class="btn-secondary">Close</button>
      </div>
    </div>
  </div>

  <footer>
    <p>&copy; 2025 Nithishwaran A. <br>All rights reserved.</p>
  </footer>

  <script>
    const modal = document.getElementById('reviewModal');
    const addReviewBtn = document.getElementById('addReviewBtn');
    const closeBtn = document.querySelector('.close');
    const cancelBtn = document.getElementById('cancelBtn');
    const reviewForm = document.getElementById('reviewForm');
    const reviewCardsContainer = document.getElementById('reviewCardsContainer');
    const emptyState = document.getElementById('emptyState');
    const modalTitle = document.getElementById('modalTitle');
    const submitBtn = document.getElementById('submitBtn');
    const reviewIdInput = document.getElementById('reviewId');
    // Details modal elements
    const reviewDetailsModal = document.getElementById('reviewDetailsModal');
    const closeReviewDetailsBtn = document.querySelector('.close-review-details');
    const closeReviewDetailsBottomBtn = document.getElementById('closeReviewDetailsBtn');
    const editReviewFromDetailsBtn = document.getElementById('editReviewFromDetailsBtn');

    // Spoiler warning modal elements
    const spoilerWarningModal = document.getElementById('spoilerWarningModal');
    const closeSpoilerWarningBtn = document.querySelector('.close-spoiler-warning');
    const continueReadingBtn = document.getElementById('continueReadingBtn');
    const cancelReadingBtn = document.getElementById('cancelReadingBtn');


    let currentReview = null;
    let pendingReviewToShow = null;

    document.addEventListener('DOMContentLoaded', async () => {
      const sessionId = localStorage.getItem('sessionId');
      if (!sessionId) {
        window.location.href = 'login.html';
        return;
      }
      displayUserInfo();
      loadReviews();
      // Check for move-to-review flow and handle it before clearing
      await maybeOpenMoveToReviewFlow();
      // Clear any pending move-to-review data to prevent showing previous movie
      localStorage.removeItem('moveToReviewMovieId');
    });

    addReviewBtn.onclick = () => {
      modalTitle.textContent = 'Add Review';
      submitBtn.textContent = 'Add Review';
      reviewIdInput.value = '';
      resetForm();
      setReviewRating(0);
      modal.style.display = 'block';
    };
    closeBtn.onclick = closeModal;
    cancelBtn.onclick = closeModal;
    window.onclick = (event) => { if (event.target === modal) closeModal(); };

    function closeModal() { modal.style.display = 'none'; resetForm(); }
    function resetForm() {
      reviewForm.reset();
      setReviewRating(0);
      selectedGenres = [];
      selectedOTT = [];
      if (typeof updateGenreDisplay === 'function') updateGenreDisplay();
      if (typeof updateOTTDisplay === 'function') updateOTTDisplay();

      // Clear dropdown selections
      document.querySelectorAll('.genre-option, .ott-option').forEach(option => {
        option.classList.remove('selected');
      });
    }

    // Star widget logic
    const reviewRatingStars = document.getElementById('reviewRatingStars');
    const reviewRatingValue = document.getElementById('reviewRatingValue');
    function setReviewRating(v) {
      reviewRatingValue.value = v;
      [...reviewRatingStars.querySelectorAll('.star')].forEach(star => {
        const val = parseInt(star.dataset.value, 10);
        star.classList.toggle('active', val <= v);
      });
    }
    if (reviewRatingStars) {
      reviewRatingStars.addEventListener('click', (e) => {
        const btn = e.target.closest('.star');
        if (!btn) return;
        setReviewRating(parseInt(btn.dataset.value, 10));
      });
      reviewRatingStars.addEventListener('mousemove', (e) => {
        const btn = e.target.closest('.star');
        if (!btn) return;
        const hv = parseInt(btn.dataset.value, 10);
        [...reviewRatingStars.querySelectorAll('.star')].forEach(star => {
          const val = parseInt(star.dataset.value, 10);
          star.classList.toggle('hover', val <= hv);
        });
      });
      reviewRatingStars.addEventListener('mouseleave', () => {
        [...reviewRatingStars.querySelectorAll('.star')].forEach(star => star.classList.remove('hover'))
      });
      // default empty on initial page load; add modal sets to 0 too
      setReviewRating(0);
    }

    // Dynamic Genre Selector for Reviews
    let selectedGenres = [];
    const genreSelector = document.getElementById('selectedGenresDisplay');
    const genreDropdown = document.getElementById('genreDropdown');

    if (genreSelector && genreDropdown) {
      genreSelector.addEventListener('click', () => {
        genreDropdown.classList.toggle('active');
      });

      document.addEventListener('click', (e) => {
        if (!genreSelector.contains(e.target) && !genreDropdown.contains(e.target)) {
          genreDropdown.classList.remove('active');
        }
      });

      genreDropdown.addEventListener('click', (e) => {
        if (e.target.classList.contains('genre-option')) {
          const genre = e.target.dataset.value;
          if (selectedGenres.includes(genre)) {
            selectedGenres = selectedGenres.filter(g => g !== genre);
            e.target.classList.remove('selected');
          } else {
            if (selectedGenres.length < 5) {
              selectedGenres.push(genre);
              e.target.classList.add('selected');
            } else {
              showNotification('Maximum 5 genres allowed', 'error');
            }
          }
          updateGenreDisplay();
        }
      });

      function updateGenreDisplay() {
        document.getElementById('selectedGenres').value = JSON.stringify(selectedGenres);
        if (selectedGenres.length === 0) {
          genreSelector.innerHTML = '<span class="placeholder">Click to select genres...</span>';
        } else {
          genreSelector.innerHTML = selectedGenres.map(genre =>
            `<span class="selected-tag" data-genre="${genre}">${genre}</span>`
          ).join('');

          // Add click handlers for removing tags
          genreSelector.querySelectorAll('.selected-tag').forEach(tag => {
            tag.addEventListener('click', (e) => {
              e.stopPropagation();
              const genreToRemove = tag.dataset.genre;
              selectedGenres = selectedGenres.filter(g => g !== genreToRemove);
              updateGenreDisplay();
              // Update dropdown selection
              document.querySelectorAll('.genre-option').forEach(option => {
                if (option.dataset.value === genreToRemove) {
                  option.classList.remove('selected');
                }
              });
            });
          });
        }
      }
    }

    // Dynamic OTT Selector for Reviews
    let selectedOTT = [];
    const ottSelector = document.getElementById('selectedOTTDisplay');
    const ottDropdown = document.getElementById('ottDropdown');

    if (ottSelector && ottDropdown) {
      ottSelector.addEventListener('click', () => {
        ottDropdown.classList.toggle('active');
      });

      document.addEventListener('click', (e) => {
        if (!ottSelector.contains(e.target) && !ottDropdown.contains(e.target)) {
          ottDropdown.classList.remove('active');
        }
      });

      ottDropdown.addEventListener('click', (e) => {
        if (e.target.classList.contains('ott-option')) {
          const platform = e.target.dataset.value;

          if (selectedOTT.includes(platform)) {
            selectedOTT = selectedOTT.filter(p => p !== platform);
            e.target.classList.remove('selected');
          } else {
            selectedOTT.push(platform);
            e.target.classList.add('selected');
          }
          updateOTTDisplay();
        }
      });

      function updateOTTDisplay() {
        document.getElementById('selectedOTT').value = JSON.stringify(selectedOTT);
        if (selectedOTT.length === 0) {
          ottSelector.innerHTML = '<span class="placeholder">Click to select platforms...</span>';
        } else {
          ottSelector.innerHTML = selectedOTT.map(platform =>
            `<span class="selected-tag" data-platform="${platform}">${platform}</span>`
          ).join('');

          // Add click handlers for removing tags
          ottSelector.querySelectorAll('.selected-tag').forEach(tag => {
            tag.addEventListener('click', (e) => {
              e.stopPropagation();
              const platformToRemove = tag.dataset.platform;
              selectedOTT = selectedOTT.filter(p => p !== platformToRemove);
              updateOTTDisplay();
              // Update dropdown selection for predefined platforms
              document.querySelectorAll('.ott-option').forEach(option => {
                if (option.dataset.value === platformToRemove) {
                  option.classList.remove('selected');
                }
              });
            });
          });
        }
      }
    }

    // Review text counter
    const reviewCounter = document.getElementById('reviewCounter');
    const reviewTextEl = document.getElementById('reviewText');
    function updateReviewCounter() {
      const len = reviewTextEl.value.length;
      reviewCounter.textContent = `${len}/500`;
      if (len > 500) reviewTextEl.value = reviewTextEl.value.slice(0, 500);
    }
    reviewTextEl.addEventListener('input', updateReviewCounter);
    updateReviewCounter();

    reviewForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const sessionId = localStorage.getItem('sessionId');
      if (!sessionId) { window.location.href = 'login.html'; return; }

      const id = reviewIdInput.value;
      const isEdit = !!id;

      const genresRaw = document.getElementById('selectedGenres').value.trim();
      let genres = [];
      try {
        genres = genresRaw ? JSON.parse(genresRaw) : [];
      } catch (e) {
        console.error('Error parsing genres:', e);
        genres = [];
      }

      const ottRaw = document.getElementById('selectedOTT').value.trim();
      let ottPlatforms = [];
      try {
        ottPlatforms = ottRaw ? JSON.parse(ottRaw) : [];
      } catch (e) {
        console.error('Error parsing OTT platforms:', e);
        ottPlatforms = [];
      }



      const payload = {
        title: document.getElementById('movieTitle').value.trim(),
        description: document.getElementById('movieDescription').value.trim(),
        genres,
        releaseYear: parseInt(document.getElementById('releaseYear').value, 10),
        posterImage: document.getElementById('posterImage').value.trim(),
        ottPlatforms,
        reviewText: document.getElementById('reviewText').value.trim(),
        ratingStars: parseInt(document.getElementById('reviewRatingValue').value, 10),
        imdbRating: parseFloat(document.getElementById('imdbRating').value) || 0,
        reviewPros: document.getElementById('reviewPros').value.trim(),
        reviewCons: document.getElementById('reviewCons').value.trim(),
        isSpoiler: document.getElementById('isSpoiler').checked,
        recommended: document.getElementById('recommended').value === 'true'
      };

      if (!payload.title || !payload.releaseYear || !(payload.ratingStars >= 0 && payload.ratingStars <= 10)) {
        showNotification('Please fill required fields correctly', 'error');
        return;
      }

      // Validate release year
      if (isNaN(payload.releaseYear) || payload.releaseYear < 1800 || payload.releaseYear > 2100) {
        showNotification('Release year must be between 1800 and 2100', 'error');
        return;
      }

      try {
        let response;
        if (!isEdit && moveFromWatchlistId) {
          // Use move-to-review endpoint to remove from watchlist and create review
          response = await fetch(`/api/movies/${moveFromWatchlistId}/move-to-review`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${sessionId}` },
            body: JSON.stringify({
              ratingStars: payload.ratingStars,
              reviewText: payload.reviewText,
              reviewPros: payload.reviewPros,
              reviewCons: payload.reviewCons,
              isSpoiler: payload.isSpoiler,
              recommended: payload.recommended
            })
          });
        } else {
          response = await fetch(isEdit ? `/api/reviews/${id}` : '/api/reviews', {
            method: isEdit ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${sessionId}` },
            body: JSON.stringify(payload)
          });
        }
        const result = await response.json();
        if (response.ok) {
          closeModal();
          loadReviews();
          showNotification(isEdit ? 'Review updated!' : 'Review added!', 'success');
          if (moveFromWatchlistId) {
            localStorage.removeItem('moveToReviewMovieId');
            moveFromWatchlistId = null;
          }
        } else {
          if (response.status === 401) {
            localStorage.removeItem('sessionId');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
          } else {
            showNotification(result.message || 'Failed to save review', 'error');
          }
        }
      } catch (err) {
        console.error('Save review error:', err);
        console.error('Payload:', payload);
        showNotification('Failed to save review. Try again.', 'error');
      }
    });

    async function loadReviews() {
      const sessionId = localStorage.getItem('sessionId');
      try {
        const response = await fetch('/api/reviews', { headers: { 'Authorization': `Bearer ${sessionId}` } });
        const result = await response.json();
        if (response.ok) {
          reviewCardsContainer.innerHTML = '';

          // Store reviews in localStorage for quick access
          localStorage.setItem('userReviews', JSON.stringify(result.reviews || []));

          if (result.reviews && result.reviews.length) {
            result.reviews.forEach(r => reviewCardsContainer.appendChild(createReviewCard(r)));
            emptyState.style.display = 'none';
            reviewCardsContainer.style.display = 'grid';
          } else {
            emptyState.style.display = 'block';
            reviewCardsContainer.style.display = 'none';
          }
        } else {
          showNotification('Failed to load reviews', 'error');
        }
      } catch (err) {
        console.error('Load reviews error:', err);
        showNotification('Failed to load reviews. Check your connection.', 'error');
      }
    }

    function createReviewCard(review) {
      const card = document.createElement('div');
      card.className = 'movie-card';
      card.dataset.reviewId = review._id || review.id;

      const posterUrl = review.posterImage || 'https://via.placeholder.com/400x600/667eea/ffffff?text=No+Poster';
      const genres = review.genres || [];
      const genresHtml = genres.length ? `<div class="movie-genres">${genres.map(g => `<span class=\"genre-tag\">${g}</span>`).join('')}</div>` : '';
      const ottPlatforms = review.ottPlatforms || [];
      const ottHtml = ottPlatforms.length ? `<div class=\"ott-platforms\"><strong>Available on:</strong><div class=\"ott-tags\">${ottPlatforms.map(p => `<span class=\"ott-tag\">${p}</span>`).join('')}</div></div>` : '';

      const stars = '★'.repeat(Math.max(0, Math.min(10, parseInt(review.ratingStars || 0)))) + '☆'.repeat(Math.max(0, 10 - parseInt(review.ratingStars || 0)));

      card.innerHTML = `
        <div class="movie-poster">
          <img src="${posterUrl}" alt="${review.title}" onerror="this.src='https://via.placeholder.com/400x600/667eea/ffffff?text=No+Poster'">
        </div>
        <div class="movie-info">
                     <h3 class="movie-title">${review.title}</h3>
           <p class="movie-year">${review.releaseYear}</p>
           ${genresHtml}
                      <div class="movie-rating"><span class="stars">${stars}</span><span class="rating-text">${review.ratingStars}/10</span></div>
           ${review.imdbRating > 0 ? `<div class="imdb-rating">IMDb: ${review.imdbRating}/10</div>` : ''}
                     <div class="movie-description">${(review.description || '').substring(0, 140)}</div>
           ${review.reviewText ? `<div class=\"movie-notes\"><strong>Your Review:</strong> ${(review.reviewText || '').substring(0, 200)}</div>` : ''}
           ${review.isSpoiler ? '<div class="spoiler-indicator">⚠️ Contains Spoilers</div>' : ''}
           ${ottHtml}
          <div class="movie-actions">
            <button class="btn-edit" onclick="editReview('${review._id || review.id}', event)">Edit</button>
            <button class="btn-delete" onclick="deleteReview('${review._id || review.id}', event)">Delete</button>
          </div>
        </div>`;

      // click to open details (exclude buttons)
      card.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON' || e.target.closest('button') || e.target.closest('.movie-actions')) return;
        showReviewDetails(review);
      });

      // Add click handler for edit button that works directly
      const editBtn = card.querySelector('.btn-edit');
      if (editBtn) {
        editBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          editReview(review._id || review.id, e);
        });
      }

      return card;
    }

    function showReviewDetails(review) {
      // Check if review contains spoilers
      if (review.isSpoiler) {
        pendingReviewToShow = review;
        spoilerWarningModal.style.display = 'block';
        return;
      }
      showReviewDetailsDirectly(review);
    }
    // When user clicks "Continue Reading"
    continueReadingBtn.addEventListener('click', function () {
      if (pendingReviewToShow) {
        showReviewDetailsDirectly(pendingReviewToShow);
        pendingReviewToShow = null; // clear after showing
      }
      spoilerWarningModal.style.display = 'none';
    });

    // When user clicks "Cancel"
    cancelReadingBtn.addEventListener('click', function () {
      pendingReviewToShow = null; // clear review
      spoilerWarningModal.style.display = 'none';
    });

    // When user clicks "X" close button
    closeSpoilerWarningBtn.addEventListener('click', function () {
      pendingReviewToShow = null;
      spoilerWarningModal.style.display = 'none';
    });

    function showReviewDetailsDirectly(review) {
      currentReview = review;
      document.getElementById('detailsReviewTitle').textContent = review.title || '';
      document.getElementById('detailsReviewYear').textContent = review.releaseYear || '';
      document.getElementById('detailsReviewStars').textContent = `${'★'.repeat(parseInt(review.ratingStars || 0))}${'☆'.repeat(10 - parseInt(review.ratingStars || 0))} (${review.ratingStars || 0}/10)`;

      // Set IMDb rating
      const imdbRating = review.imdbRating || 0;
      document.getElementById('detailsReviewIMDb').textContent = imdbRating > 0 ? `${imdbRating}/10` : 'Not rated';

      const posterImg = document.getElementById('detailsReviewPoster');
      posterImg.src = review.posterImage || 'https://via.placeholder.com/400x600/667eea/ffffff?text=No+Poster';
      posterImg.alt = review.title || '';

      const genresContainer = document.getElementById('detailsReviewGenres');
      genresContainer.innerHTML = '';
      (review.genres || []).forEach(g => {
        const span = document.createElement('span');
        span.className = 'genre-tag';
        span.textContent = g;
        genresContainer.appendChild(span);
      });

      const ottContainer = document.getElementById('detailsReviewOTT');
      ottContainer.innerHTML = '';
      (review.ottPlatforms || []).forEach(p => {
        const span = document.createElement('span');
        span.className = 'ott-tag';
        span.textContent = p;
        ottContainer.appendChild(span);
      });
      if ((review.ottPlatforms || []).length === 0) ottContainer.textContent = 'Not specified';

      document.getElementById('detailsReviewDescription').textContent = review.description || '';
      const textRow = document.getElementById('detailsReviewTextRow');
      const textEl = document.getElementById('detailsReviewText');
      if (review.reviewText) { textEl.textContent = review.reviewText; textRow.style.display = 'flex'; } else { textRow.style.display = 'none'; }

      const prosConsRow = document.getElementById('detailsProsConsRow');
      const prosEl = document.getElementById('detailsPros');
      const consEl = document.getElementById('detailsCons');
      const flagsEl = document.getElementById('detailsFlags');
      prosEl.innerHTML = review.reviewPros ? `<strong>Pros:</strong> ${review.reviewPros}` : '';
      consEl.innerHTML = review.reviewCons ? `<strong>Cons:</strong> ${review.reviewCons}` : '';
      flagsEl.innerHTML = `<strong>Recommend:</strong> ${review.recommended ? 'Yes' : 'No'} ${review.isSpoiler ? '(Contains spoilers)' : ''}`;
      prosConsRow.style.display = (review.reviewPros || review.reviewCons || typeof review.recommended === 'boolean' || review.isSpoiler) ? 'flex' : 'none';

      reviewDetailsModal.style.display = 'block';
    }

    function closeReviewDetails() {
      reviewDetailsModal.style.display = 'none';
      currentReview = null;
    }

    function closeSpoilerWarning() {
      spoilerWarningModal.style.display = 'none';
      pendingReviewToShow = null;
    }
    closeReviewDetailsBtn.onclick = closeReviewDetails;
    closeReviewDetailsBottomBtn.onclick = closeReviewDetails;
    window.addEventListener('click', (e) => { if (e.target === reviewDetailsModal) closeReviewDetails(); });
    editReviewFromDetailsBtn.onclick = () => { if (currentReview) { openEditModal(currentReview); closeReviewDetails(); } };

    // Spoiler warning modal handlers
    closeSpoilerWarningBtn.onclick = closeSpoilerWarning;
    cancelReadingBtn.onclick = closeSpoilerWarning;
    continueReadingBtn.onclick = () => {
      closeSpoilerWarning();
      if (pendingReviewToShow) {
        showReviewDetailsDirectly(pendingReviewToShow);
        pendingReviewToShow = null;
      }
    };
    window.addEventListener('click', (e) => { if (e.target === spoilerWarningModal) closeSpoilerWarning(); });

    function openEditModal(review) {
      modalTitle.textContent = 'Edit Review';
      submitBtn.textContent = 'Update Review';
      reviewIdInput.value = review._id || review.id;

      document.getElementById('movieTitle').value = review.title || '';
      document.getElementById('movieDescription').value = review.description || '';
      // Set genres
      selectedGenres = Array.isArray(review.genres) ? [...review.genres] : [];
      updateGenreDisplay();

      // Update dropdown selections for genres
      document.querySelectorAll('.genre-option').forEach(option => {
        option.classList.toggle('selected', selectedGenres.includes(option.dataset.value));
      });

      document.getElementById('releaseYear').value = review.releaseYear || '';
      setReviewRating(review.ratingStars || 0);
      document.getElementById('posterImage').value = review.posterImage || '';
      document.getElementById('imdbRating').value = review.imdbRating || '';

      // Set OTT platforms
      selectedOTT = Array.isArray(review.ottPlatforms) ? [...review.ottPlatforms] : [];
      updateOTTDisplay();

      // Update dropdown selections for OTT platforms
      document.querySelectorAll('.ott-option').forEach(option => {
        option.classList.toggle('selected', selectedOTT.includes(option.dataset.value));
      });
      document.getElementById('reviewText').value = review.reviewText || '';
      document.getElementById('reviewPros').value = review.reviewPros || '';
      document.getElementById('reviewCons').value = review.reviewCons || '';
      document.getElementById('isSpoiler').checked = !!review.isSpoiler;
      document.getElementById('recommended').value = String(typeof review.recommended === 'boolean' ? review.recommended : true);

      const reviewCounter = document.getElementById('reviewCounter');
      if (reviewCounter) reviewCounter.textContent = `${(review.reviewText || '').length}/500`;

      modal.style.display = 'block';
    }

    // Move-to-review flow from Watchlist
    let moveFromWatchlistId = null;
    async function maybeOpenMoveToReviewFlow() {
      const pendingId = localStorage.getItem('moveToReviewMovieId');
      if (!pendingId) return;
      const sessionId = localStorage.getItem('sessionId');
      try {
        const res = await fetch('/api/movies', { headers: { 'Authorization': `Bearer ${sessionId}` } });
        const data = await res.json();
        if (res.ok) {
          const movie = (data.movies || []).find(m => (m._id || m.id) === pendingId);
          if (movie) {
            moveFromWatchlistId = pendingId;
            // Prefill form with movie details
            modalTitle.textContent = 'Add Review';
            submitBtn.textContent = 'Add Review';
            reviewIdInput.value = '';
            resetForm();
            document.getElementById('movieTitle').value = movie.title || '';
            document.getElementById('movieDescription').value = movie.description || '';

            // Set genres
            selectedGenres = Array.isArray(movie.genres) ? [...movie.genres] : [];
            updateGenreDisplay();

            // Update dropdown selections for genres
            document.querySelectorAll('.genre-option').forEach(option => {
              option.classList.toggle('selected', selectedGenres.includes(option.dataset.value));
            });

            document.getElementById('releaseYear').value = movie.releaseYear || '';
            document.getElementById('posterImage').value = movie.posterImage || '';

            // Set OTT platforms
            selectedOTT = Array.isArray(movie.ottPlatforms) ? [...movie.ottPlatforms] : [];
            updateOTTDisplay();

            // Update dropdown selections for OTT platforms
            document.querySelectorAll('.ott-option').forEach(option => {
              option.classList.toggle('selected', selectedOTT.includes(option.dataset.value));
            });

            setReviewRating(0);
            modal.style.display = 'block';
          }
        }
      } catch { }
    }

    async function deleteReview(reviewId, event) {
      if (event) event.stopPropagation();
      if (!confirm('Delete this review?')) return;
      const sessionId = localStorage.getItem('sessionId');
      try {
        const response = await fetch(`/api/reviews/${reviewId}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${sessionId}` } });
        const result = await response.json();
        if (response.ok) {
          showNotification('Review deleted', 'success');
          loadReviews();
        } else {
          showNotification(result.message || 'Failed to delete review', 'error');
        }
      } catch (err) {
        console.error('Delete review error:', err);
        showNotification('Failed to delete review. Try again.', 'error');
      }
    }

    // Function to edit review
    function editReview(reviewId, event) {
      if (event) {
        event.stopPropagation();
      }

      // Check if user is authenticated
      const sessionId = localStorage.getItem('sessionId');
      if (!sessionId) {
        showNotification('Please login to edit reviews', 'error');
        window.location.href = 'login.html';
        return;
      }

      // Get review data from stored reviews or find in current display
      const reviews = JSON.parse(localStorage.getItem('userReviews') || '[]');
      const review = reviews.find(r => (r._id || r.id) === reviewId);

      if (review) {
        openEditModal(review);
      } else {
        showNotification('Review not found', 'error');
      }
    }

    function showNotification(message, type = 'info') {
      document.querySelectorAll('.notification').forEach(n => n.remove());
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => { if (notification.parentElement) notification.remove(); }, 4000);
    }

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      const sessionId = localStorage.getItem('sessionId');
      if (sessionId) {
        try { await fetch('/api/logout', { method: 'POST', headers: { 'Authorization': `Bearer ${sessionId}` } }); } catch { }
      }
      localStorage.removeItem('sessionId');
      localStorage.removeItem('user');
      showNotification('Logged out successfully', 'success');
      setTimeout(() => { window.location.href = 'login.html'; }, 800);
    });

    function displayUserInfo() {
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      const userDisplay = document.getElementById('userDisplay');
      if (user.firstName && user.lastName) userDisplay.textContent = `Welcome, ${user.firstName} ${user.lastName}!`;
      else if (user.username) userDisplay.textContent = `Welcome, ${user.username}!`;
      else userDisplay.textContent = 'Welcome!';
    }
  </script>
</body>

</html>