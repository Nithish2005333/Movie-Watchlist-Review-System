<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Watchlist - Movie Vault</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Montserrat:wght@400;700;800&family=Poppins:wght@400;700&family=Roboto:wght@400;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="style/watchlist.css">
</head>

<body>
  <div class="container">
    <div class="header-section">
      <h1>ðŸŽ¬ <span class="vault">MOVIE VAULT</span> - Watchlist</h1>
      <div class="user-info">
        <span id="userDisplay"></span>
        <button id="logoutBtn" class="logout-btn">Logout</button>
      </div>
    </div>

    <div class="nav-links">
      <a href="movies.html" class="nav-link">Back to Movies</a>
    </div>

    <!-- Add Movie Button -->
    <div class="add-movie-section">
      <button id="addMovieBtn" class="add-movie-btn">
        <span class="btn-icon">ðŸŽ¬</span>
        <span class="btn-text">Add Movie to Watchlist</span>
      </button>
    </div>

    <!-- Movie Cards Container -->
    <div id="movieCardsContainer" class="movie-cards-container">
      <!-- Movie cards will be dynamically added here -->
    </div>
    
    <!-- Empty State -->
    <div id="emptyState" class="empty-state" style="display: none;">
      <h3>ðŸŽ¬ Your Watchlist is Empty</h3>
      <p>Start building your movie collection by adding your first movie!</p>
    </div>
  </div>

  <!-- Modal for Add/Edit Movie -->
  <div id="movieModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Add Movie to Watchlist</h2>
        <span class="close">&times;</span>
      </div>
      
      <form id="movieForm" class="movie-form">
        <input type="hidden" id="movieId" name="movieId" value="">
        
        <div class="form-group">
          <label for="movieTitle">Movie Title</label>
          <input type="text" id="movieTitle" name="title" placeholder="Enter movie title" required>
        </div>

        <div class="form-group">
          <label for="movieDescription">Description</label>
          <textarea id="movieDescription" name="description" rows="4" placeholder="Enter movie description" required></textarea>
        </div>

        <div class="form-group">
          <label for="movieGenres">Genres (Select multiple)</label>
          <div class="genre-selector">
            <div class="selected-genres" id="selectedGenresDisplay">
              <span class="placeholder">Click to select genres...</span>
            </div>
            <div class="genre-dropdown" id="genreDropdown">
              <div class="genre-option" data-value="Action">Action</div>
              <div class="genre-option" data-value="Adventure">Adventure</div>
              <div class="genre-option" data-value="Animation">Animation</div>
              <div class="genre-option" data-value="Biography">Biography</div>
              <div class="genre-option" data-value="Comedy">Comedy</div>
              <div class="genre-option" data-value="Crime">Crime</div>
              <div class="genre-option" data-value="Documentary">Documentary</div>
              <div class="genre-option" data-value="Drama">Drama</div>
              <div class="genre-option" data-value="Family">Family</div>
              <div class="genre-option" data-value="Fantasy">Fantasy</div>
              <div class="genre-option" data-value="History">History</div>
              <div class="genre-option" data-value="Horror">Horror</div>
              <div class="genre-option" data-value="Musical">Musical</div>
              <div class="genre-option" data-value="Mystery">Mystery</div>
              <div class="genre-option" data-value="Romance">Romance</div>
              <div class="genre-option" data-value="Sci-Fi">Sci-Fi</div>
              <div class="genre-option" data-value="Sports">Sports</div>
              <div class="genre-option" data-value="Thriller">Thriller</div>
              <div class="genre-option" data-value="War">War</div>
              <div class="genre-option" data-value="Western">Western</div>
              <div class="genre-option" data-value="Superhero">Superhero</div>
              <div class="genre-option" data-value="Slice of Life">Slice of Life</div>
              <div class="genre-option" data-value="Psychological">Psychological</div>
              <div class="genre-option" data-value="Suspense">Suspense</div>
              <div class="genre-option" data-value="Political">Political</div>
              <div class="genre-option" data-value="Period Drama">Period Drama</div>
              <div class="genre-option" data-value="Experimental">Experimental</div>
              <div class="genre-option" data-value="Short Films">Short Films</div>
              <div class="genre-option" data-value="Reality">Reality</div>
              <div class="genre-option" data-value="Talk Show">Talk Show</div>
              <div class="genre-option" data-value="Game Show">Game Show</div>
              <div class="genre-option" data-value="Action-Comedy">Action-Comedy</div>
              <div class="genre-option" data-value="Black Comedy">Black Comedy</div>
              <div class="genre-option" data-value="Dark Fantasy">Dark Fantasy</div>
              <div class="genre-option" data-value="Paranormal">Paranormal</div>
              <div class="genre-option" data-value="Teen">Teen</div>
              <div class="genre-option" data-value="Coming-of-Age">Coming-of-Age</div>
              <div class="genre-option" data-value="Martial Arts">Martial Arts</div>
              <div class="genre-option" data-value="Spy/Espionage">Spy/Espionage</div>
              <div class="genre-option" data-value="Heist">Heist</div>
              <div class="genre-option" data-value="Survival">Survival</div>
              <div class="genre-option" data-value="Disaster">Disaster</div>
              <div class="genre-option" data-value="Cyberpunk">Cyberpunk</div>
              <div class="genre-option" data-value="Steampunk">Steampunk</div>
              <div class="genre-option" data-value="Post-Apocalyptic">Post-Apocalyptic</div>
              <div class="genre-option" data-value="Dystopian">Dystopian</div>
              <div class="genre-option" data-value="Space Opera">Space Opera</div>
              <div class="genre-option" data-value="Gothic">Gothic</div>
              <div class="genre-option" data-value="Tragedy">Tragedy</div>
              <div class="genre-option" data-value="Legal/Courtroom">Legal/Courtroom</div>
              <div class="genre-option" data-value="Medical">Medical</div>
              <div class="genre-option" data-value="Military">Military</div>
              <div class="genre-option" data-value="Mythology">Mythology</div>
              <div class="genre-option" data-value="Folklore">Folklore</div>
              <div class="genre-option" data-value="Historical Fiction">Historical Fiction</div>
              <div class="genre-option" data-value="Anthology">Anthology</div>
              <div class="genre-option" data-value="Romantic Comedy (Rom-Com)">Romantic Comedy (Rom-Com)</div>
              <div class="genre-option" data-value="Drama-Comedy (Dramedy)">Drama-Comedy (Dramedy)</div>
              <div class="genre-option" data-value="Detective/Whodunit">Detective/Whodunit</div>
              <div class="genre-option" data-value="Educational">Educational</div>
              <div class="genre-option" data-value="Stand-Up Comedy">Stand-Up Comedy</div>
              <div class="genre-option" data-value="Travel">Travel</div>
              <div class="genre-option" data-value="Cooking/Food">Cooking/Food</div>
              <div class="genre-option" data-value="Music/Concert">Music/Concert</div>
              <div class="genre-option" data-value="Dance">Dance</div>
              <div class="genre-option" data-value="Idol/Pop Culture">Idol/Pop Culture</div>
              <div class="genre-option" data-value="Ecchi">Ecchi</div>
              <div class="genre-option" data-value="Mecha">Mecha</div>
              <div class="genre-option" data-value="Isekai">Isekai</div>
              <div class="genre-option" data-value="Shonen">Shonen</div>
              <div class="genre-option" data-value="Shojo">Shojo</div>
              <div class="genre-option" data-value="Seinen">Seinen</div>
              <div class="genre-option" data-value="Josei">Josei</div>
            </div>
          </div>
          <input type="hidden" id="selectedGenres" name="selectedGenres">
        </div>

        <div class="form-group">
          <label for="ottPlatforms">Available on OTT Platforms (Optional)</label>
          <div class="ott-selector">
            <div class="selected-ott" id="selectedOTTDisplay">
              <span class="placeholder">Click to select platforms...</span>
            </div>
            <div class="ott-dropdown" id="ottDropdown">
              <div class="ott-option" data-value="Netflix">Netflix</div>
              <div class="ott-option" data-value="Amazon Prime Video">Amazon Prime Video</div>
              <div class="ott-option" data-value="Disney+">Disney+</div>
              <div class="ott-option" data-value="YouTube Premium">YouTube Premium</div>
              <div class="ott-option" data-value="JioCinema / Disney+ Hotstar">JioCinema / Disney+ Hotstar</div>
              <div class="ott-option" data-value="WeTV">WeTV</div>
              <div class="ott-option" data-value="Max (HBO Max)">Max (HBO Max)</div>
              <div class="ott-option" data-value="iQiyi">iQiyi</div>
              <div class="ott-option" data-value="Hulu">Hulu</div>
              <div class="ott-option" data-value="Paramount+">Paramount+</div>
              <div class="ott-option" data-value="SonyLIV">SonyLIV</div>
              <div class="ott-option" data-value="ZEE5">ZEE5</div>
              <div class="ott-option" data-value="MX Player">MX Player</div>
              <div class="ott-option" data-value="Apple TV+">Apple TV+</div>
              <div class="ott-option" data-value="Peacock">Peacock</div>
              <div class="ott-option" data-value="Roku / The Roku Channel">Roku / The Roku Channel</div>
              <div class="ott-option" data-value="Pluto TV">Pluto TV</div>
              <div class="ott-option" data-value="Plex">Plex</div>
              <div class="ott-option" data-value="Twitch">Twitch</div>
              <div class="ott-option" data-value="TikTok TV">TikTok TV</div>
              <div class="ott-option" data-value="Hoichoi">Hoichoi</div>
              <div class="ott-option" data-value="Eros Now">Eros Now</div>
              <div class="ott-option" data-value="ALTBalaji (ALTT)">ALTBalaji (ALTT)</div>
              <div class="ott-option" data-value="Voot">Voot</div>
              <div class="ott-option" data-value="Aha">Aha</div>
              <div class="ott-option" data-value="Sun NXT">Sun NXT</div>
              <div class="ott-option" data-value="Discovery+">Discovery+</div>
              <div class="ott-option" data-value="DocuBay">DocuBay</div>
              <div class="ott-option" data-value="ManoramaMAX">ManoramaMAX</div>
              <div class="ott-option" data-value="ShemarooMe">ShemarooMe</div>
              <div class="ott-option" data-value="Hungama Play">Hungama Play</div>
              <div class="ott-option" data-value="Lionsgate Play">Lionsgate Play</div>
              <div class="ott-option" data-value="Apple iTunes Movies">Apple iTunes Movies</div>
              <div class="ott-option" data-value="Google TV (Movies & Shows)">Google TV (Movies & Shows)</div>
              <div class="ott-option" data-value="Crunchyroll">Crunchyroll</div>
              <div class="ott-option" data-value="HIDIVE">HIDIVE</div>
              <div class="ott-option" data-value="RetroCrush">RetroCrush</div>
              <div class="ott-option" data-value="Anime Box">Anime Box</div>
              <div class="ott-option" data-value="d-anime Store">d-anime Store</div>
              <div class="ott-option" data-value="Abema">Abema</div>
              <div class="ott-option" data-value="Bilibili">Bilibili</div>
              <div class="ott-option" data-value="Kanopy">Kanopy</div>
              <div class="ott-option" data-value="Anime Times">Anime Times</div>
            </div>
          </div>

          <input type="hidden" id="selectedOTT" name="selectedOTT">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="releaseYear">Release Year</label>
            <input type="number" id="releaseYear" name="releaseYear" placeholder="2024" min="1800" max="2100" required>
          </div>
          <div class="form-group">
            <label for="rating">IMDB Rating (0-10)</label>
            <input type="number" id="rating" name="rating" placeholder="0" min="0" max="10" step="0.1">
          </div>
        </div>

        <div class="form-group">
          <label for="posterImage">Poster Image URL</label>
          <input type="url" id="posterImage" name="posterImage" placeholder="https://example.com/poster.jpg">
        </div>

        <div class="form-group">
          <label for="notes">Notes (Optional)</label>
          <textarea id="notes" name="notes" rows="3" placeholder="Any additional notes about the movie"></textarea>
        </div>

        <div class="form-actions">
          <button type="button" id="cancelBtn" class="btn-secondary">Cancel</button>
          <button type="submit" class="btn-primary" id="submitBtn">Add Movie</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Movie Details Modal -->
  <div id="movieDetailsModal" class="modal">
    <div class="modal-content movie-details-modal">
      <div class="modal-header">
        <h2 id="detailsMovieTitle"></h2>
        <span class="close close-details">&times;</span>
      </div>
      
      <div class="movie-details-content">
        <div class="movie-details-poster">
          <img id="detailsPoster" src="" alt="Movie Poster">
        </div>
        
        <div class="movie-details-info">
          <div class="details-row">
            <span class="details-label">Release Year:</span>
            <span id="detailsReleaseYear"></span>
          </div>
          
          <div class="details-row">
            <span class="details-label">Rating:</span>
            <span id="detailsRating"></span>
          </div>
          
          <div class="details-row">
            <span class="details-label">Genres:</span>
            <div id="detailsGenres" class="details-genres"></div>
          </div>
          
          <div class="details-row">
            <span class="details-label">OTT Platforms:</span>
            <div id="detailsOTT" class="details-ott"></div>
          </div>
          
          <div class="details-row full-width">
            <span class="details-label">Description:</span>
            <p id="detailsDescription"></p>
          </div>
          
          <div class="details-row full-width" id="notesRow" style="display: none;">
            <span class="details-label">Notes:</span>
            <p id="detailsNotes"></p>
          </div>
        </div>
      </div>
      
      <div class="movie-details-actions">
        <button id="editMovieBtn" class="btn-primary">Edit Movie</button>
        <button id="closeDetailsBtn" class="btn-secondary">Close</button>
      </div>
    </div>
  </div>

  <!-- Move To Review Modal -->
  <div id="moveReviewModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Move to Review</h2>
        <span class="close close-move-review">&times;</span>
      </div>
      <form id="moveReviewForm" class="movie-form">
        <input type="hidden" id="moveReviewMovieId" value="">
        <div class="form-group">
          <label>Your Rating</label>
          <div class="rating-stars" id="moveRatingStars">
            <button type="button" class="star" data-value="1">â˜…</button>
            <button type="button" class="star" data-value="2">â˜…</button>
            <button type="button" class="star" data-value="3">â˜…</button>
            <button type="button" class="star" data-value="4">â˜…</button>
            <button type="button" class="star" data-value="5">â˜…</button>
            <button type="button" class="star" data-value="6">â˜…</button>
            <button type="button" class="star" data-value="7">â˜…</button>
            <button type="button" class="star" data-value="8">â˜…</button>
            <button type="button" class="star" data-value="9">â˜…</button>
            <button type="button" class="star" data-value="10">â˜…</button>
          </div>
          <input type="hidden" id="moveRatingValue" value="10">
        </div>
        <div class="form-group">
          <label>Write a Review (optional)</label>
          <textarea id="moveReviewText" rows="4" placeholder="Share your thoughts..."></textarea>
          <div class="helper-text" id="moveReviewCounter">0/500</div>
        </div>
        <div class="form-actions">
          <button type="button" id="moveCancelBtn" class="btn-secondary">Cancel</button>
          <button type="submit" class="btn-primary">Confirm Move</button>
        </div>
      </form>
    </div>
  </div>

  <footer>
    <p>&copy; 2025 Nithishwaran A. <br>All rights reserved.</p>
  </footer>

  <script>
    // DOM Elements
    const modal = document.getElementById('movieModal');
    const detailsModal = document.getElementById('movieDetailsModal');
    const addMovieBtn = document.getElementById('addMovieBtn');
    const closeBtn = document.querySelector('.close');
    const closeDetailsBtn = document.querySelector('.close-details');
    const cancelBtn = document.getElementById('cancelBtn');
    const movieForm = document.getElementById('movieForm');
    const movieCardsContainer = document.getElementById('movieCardsContainer');
    const emptyState = document.getElementById('emptyState');
    const modalTitle = document.getElementById('modalTitle');
    const submitBtn = document.getElementById('submitBtn');
    const movieIdInput = document.getElementById('movieId');
    const editMovieBtn = document.getElementById('editMovieBtn');
    const closeDetailsModalBtn = document.getElementById('closeDetailsBtn');
    // Move to Review modal elements
    const moveReviewModal = document.getElementById('moveReviewModal');
    const closeMoveReviewBtn = document.querySelector('.close-move-review');
    const moveReviewForm = document.getElementById('moveReviewForm');
    const moveReviewMovieId = document.getElementById('moveReviewMovieId');
    const moveRatingStars = document.getElementById('moveRatingStars');
    const moveRatingValue = document.getElementById('moveRatingValue');
    const moveReviewText = document.getElementById('moveReviewText');
    const moveReviewCounter = document.getElementById('moveReviewCounter');
    const moveCancelBtn = document.getElementById('moveCancelBtn');
    
    // Current movie being edited/viewed
    let currentMovie = null;
    let selectedGenres = [];
    let selectedOTT = [];

    // Check authentication on page load
    document.addEventListener('DOMContentLoaded', () => {
      const sessionId = localStorage.getItem('sessionId');
      if (!sessionId) {
        showNotification('Please login to access your watchlist', 'error');
        window.location.href = 'login.html';
        return;
      }
      displayUserInfo();
      loadMovies();
    });

    // Modal functionality
    addMovieBtn.onclick = () => {
      modalTitle.textContent = "Add Movie to Watchlist";
      submitBtn.textContent = "Add Movie";
      movieIdInput.value = "";
      resetForm();
      modal.style.display = 'block';
    };

    closeBtn.onclick = closeModal;
    closeDetailsBtn.onclick = closeDetailsModal;
    cancelBtn.onclick = closeModal;
    closeDetailsModalBtn.onclick = closeDetailsModal;
    closeMoveReviewBtn.onclick = closeMoveToReviewModal;
    moveCancelBtn.onclick = closeMoveToReviewModal;

    // Close modal when clicking outside
    window.onclick = (event) => {
      if (event.target === modal) {
        closeModal();
      }
      if (event.target === detailsModal) {
        closeDetailsModal();
      }
      if (event.target === moveReviewModal) {
        closeMoveToReviewModal();
      }
    };

    // Edit movie button handler
    editMovieBtn.onclick = () => {
      if (currentMovie) {
        openEditModal(currentMovie);
      }
      closeDetailsModal();
    };

    function openEditModal(movie) {
      modalTitle.textContent = "Edit Movie";
      submitBtn.textContent = "Update Movie";
      movieIdInput.value = movie._id || movie.id;
      
      // Fill form with movie data
      document.getElementById('movieTitle').value = movie.title || '';
      document.getElementById('movieDescription').value = movie.description || '';
      document.getElementById('releaseYear').value = movie.releaseYear || '';
      document.getElementById('rating').value = movie.rating || 0;
      document.getElementById('posterImage').value = movie.posterImage || '';
      document.getElementById('notes').value = movie.notes || '';
      
      // Set genres
      selectedGenres = Array.isArray(movie.genres) ? [...movie.genres] : 
                      (movie.genre ? [movie.genre] : []);
      updateGenreDisplay();
      
      // Set OTT platforms
      selectedOTT = Array.isArray(movie.ottPlatforms) ? [...movie.ottPlatforms] : [];
      updateOTTDisplay();
      
      // Show modal
      modal.style.display = 'block';
    }

    function resetForm() {
      movieForm.reset();
      selectedGenres = [];
      selectedOTT = [];
      updateGenreDisplay();
      updateOTTDisplay();
      
      // Clear dropdown selections
      document.querySelectorAll('.genre-option, .ott-option').forEach(option => {
        option.classList.remove('selected');
      });
    }

    function closeModal() {
      modal.style.display = 'none';
      resetForm();
    }

    function closeDetailsModal() {
      detailsModal.style.display = 'none';
      currentMovie = null;
    }

    function openMoveToReviewModalFor(movieId) {
      moveReviewMovieId.value = movieId;
      setMoveRating(5);
      moveReviewText.value = '';
      updateMoveCounter();
      moveReviewModal.style.display = 'block';
    }

    function closeMoveToReviewModal() {
      moveReviewModal.style.display = 'none';
      moveReviewMovieId.value = '';
    }

    // Handle form submission
    movieForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Check if user is authenticated
      const sessionId = localStorage.getItem('sessionId');
      if (!sessionId) {
        showNotification('Please login to add movies to your watchlist', 'error');
        window.location.href = 'login.html';
        return;
      }
      
      const movieId = movieIdInput.value;
      const isEdit = !!movieId;
      
      // Validate genres
      if (selectedGenres.length === 0) {
        showNotification('Please select at least one genre', 'error');
        return;
      }
      
      if (selectedGenres.length > 5) {
        showNotification('You can select maximum 5 genres', 'error');
        return;
      }
      
      const movieData = {
        title: document.getElementById('movieTitle').value.trim(),
        description: document.getElementById('movieDescription').value.trim(),
        genres: selectedGenres,
        releaseYear: parseInt(document.getElementById('releaseYear').value),
        rating: parseFloat(document.getElementById('rating').value) || 0,
        posterImage: document.getElementById('posterImage').value.trim(),
        ottPlatforms: selectedOTT,
        notes: document.getElementById('notes').value.trim()
      };

      // Validate required fields
      if (!movieData.title || !movieData.description || !movieData.releaseYear) {
        showNotification('Please fill in all required fields', 'error');
        return;
      }

      // Validate release year
      if (isNaN(movieData.releaseYear) || movieData.releaseYear < 1800 || movieData.releaseYear > 2100) {
        showNotification('Release year must be between 1800 and 2100', 'error');
        return;
      }

      // Validate rating
      if (movieData.rating < 0 || movieData.rating > 11) {
        showNotification('Rating must be between 0 and 11', 'error');
        return;
      }

      try {
        const url = isEdit ? `/api/movies/${movieId}` : '/api/movies';
        const method = isEdit ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${sessionId}`
          },
          body: JSON.stringify(movieData)
        });

        const result = await response.json();

        if (response.ok) {
          closeModal();
          loadMovies();
          showNotification(isEdit ? 'Movie updated successfully!' : 'Movie added to watchlist successfully!', 'success');
        } else {
          if (response.status === 401) {
            showNotification('Session expired. Please login again.', 'error');
            localStorage.removeItem('sessionId');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
          } else {
            showNotification(result.message || (isEdit ? 'Failed to update movie' : 'Failed to add movie'), 'error');
          }
        }
      } catch (error) {
        console.error('Error saving movie:', error);
        console.error('Movie data:', movieData);
        showNotification('Failed to save movie. Please try again.', 'error');
      }
    });

    // Function to create movie card
    function createMovieCard(movie) {
      const card = document.createElement('div');
      card.className = 'movie-card';
      card.dataset.movieId = movie._id || movie.id;

      const posterUrl = movie.posterImage || 'https://via.placeholder.com/400x600/667eea/ffffff?text=No+Poster';
      
      // Handle genres (support both old single genre and new multiple genres)
      const genres = movie.genres || (movie.genre ? [movie.genre] : []);
      const genresHtml = genres.length > 0 ? 
        `<div class="movie-genres">${genres.map(genre => `<span class="genre-tag">${genre}</span>`).join('')}</div>` : '';
      
      // Handle OTT platforms
      const ottPlatforms = movie.ottPlatforms || [];
      const ottHtml = ottPlatforms.length > 0 ? 
        `<div class="ott-platforms">
          <strong>Available on:</strong>
          <div class="ott-tags">${ottPlatforms.map(platform => `<span class="ott-tag">${platform}</span>`).join('')}</div>
        </div>` : '';
      
      // Create description preview (show only first 120 characters)
      const descriptionPreview = movie.description && movie.description.length > 120 ? 
        movie.description.substring(0, 120) + '...' : movie.description;
      
      // Create notes preview (show only if exists and limit to 80 characters)
      const notesPreview = movie.notes && movie.notes.length > 80 ? 
        movie.notes.substring(0, 80) + '...' : movie.notes;
      const notesHtml = movie.notes ? `
        <div class="movie-notes">
          <strong>Notes:</strong> ${notesPreview}
        </div>` : '';
      
      card.innerHTML = `
        <div class="movie-poster">
          <img src="${posterUrl}" alt="${movie.title}" onerror="this.src='https://via.placeholder.com/400x600/667eea/ffffff?text=No+Poster'">
        </div>
        <div class="movie-info">
          <h3 class="movie-title">${movie.title}</h3>
          <p class="movie-year">${movie.releaseYear}</p>
          ${genresHtml}
          <div class="movie-rating">
            <span class="stars">${'â˜…'.repeat(Math.floor(movie.rating || 0))}${'â˜†'.repeat(11 - Math.floor(movie.rating || 0))}</span>
            <span class="rating-text">${movie.rating || 0}/11</span>
          </div>
          <div class="movie-description">
            ${descriptionPreview}
          </div>
          ${ottHtml}
          ${notesHtml}
          <div class="movie-actions">
            <button class="btn-edit" onclick="editMovie('${movie._id || movie.id}', event)">Edit</button>
            <button class="btn-delete" onclick="deleteMovie('${movie._id || movie.id}', event)">Delete</button>
            <button class="btn-primary" onclick=('${movie._id || movie.id}', event)">Move to Review</button>
          </div>
        </div>
      `;

      // Add click event to show full details (but not on buttons)
      card.addEventListener('click', (e) => {
        // Don't trigger if clicking on buttons or their parent
        if (e.target.tagName === 'BUTTON' || e.target.closest('button') || e.target.closest('.movie-actions')) {
          return;
        }
        showMovieDetails(movie);
      });

      return card;
    }

    // Function to show movie details
    function showMovieDetails(movie) {
      currentMovie = movie;
      
      // Set details content
      document.getElementById('detailsMovieTitle').textContent = movie.title;
      document.getElementById('detailsReleaseYear').textContent = movie.releaseYear;
      document.getElementById('detailsRating').textContent = `${movie.rating || 0}/10`;
      document.getElementById('detailsDescription').textContent = movie.description;
      
      // Set poster
      const posterImg = document.getElementById('detailsPoster');
      posterImg.src = movie.posterImage || 'https://via.placeholder.com/400x600/667eea/ffffff?text=No+Poster';
      posterImg.alt = movie.title;
      
      // Set genres
      const genresContainer = document.getElementById('detailsGenres');
      genresContainer.innerHTML = '';
      const genres = movie.genres || (movie.genre ? [movie.genre] : []);
      genres.forEach(genre => {
        const genreSpan = document.createElement('span');
        genreSpan.className = 'genre-tag';
        genreSpan.textContent = genre;
        genresContainer.appendChild(genreSpan);
      });
      
      // Set OTT platforms
      const ottContainer = document.getElementById('detailsOTT');
      ottContainer.innerHTML = '';
      const ottPlatforms = movie.ottPlatforms || [];
      if (ottPlatforms.length > 0) {
        ottPlatforms.forEach(platform => {
          const ottSpan = document.createElement('span');
          ottSpan.className = 'ott-tag';
          ottSpan.textContent = platform;
          ottContainer.appendChild(ottSpan);
        });
      } else {
        ottContainer.textContent = 'Not specified';
      }
      
      // Set notes
      const notesRow = document.getElementById('notesRow');
      const notesElement = document.getElementById('detailsNotes');
      if (movie.notes) {
        notesElement.textContent = movie.notes;
        notesRow.style.display = 'flex';
      } else {
        notesRow.style.display = 'none';
      }
      
      // Show details modal
      detailsModal.style.display = 'block';
    }

    // Function to edit movie
    function editMovie(movieId, event) {
      if (event) {
        event.stopPropagation();
      }
      
      // Check if user is authenticated
      const sessionId = localStorage.getItem('sessionId');
      if (!sessionId) {
        showNotification('Please login to edit movies', 'error');
        window.location.href = 'login.html';
        return;
      }

      // Get movie data from stored movies or find in current display
      const movies = JSON.parse(localStorage.getItem('userMovies') || '[]');
      const movie = movies.find(m => (m._id || m.id) === movieId);
      
      if (movie) {
        openEditModal(movie);
      } else {
        showNotification('Movie not found', 'error');
      }
    }

    // Function to load all movies
    async function loadMovies() {
      try {
        // Check if user is authenticated
        const sessionId = localStorage.getItem('sessionId');
        if (!sessionId) {
          showNotification('Please login to view your watchlist', 'error');
          window.location.href = 'login.html';
          return;
        }

        const response = await fetch('/api/movies', {
          headers: {
            'Authorization': `Bearer ${sessionId}`
          }
        });
        const result = await response.json();

        if (response.ok) {
          movieCardsContainer.innerHTML = '';
          
          // Store movies in localStorage for quick access
          localStorage.setItem('userMovies', JSON.stringify(result.movies || []));
          
          if (result.movies && result.movies.length > 0) {
            result.movies.forEach(movie => {
              const card = createMovieCard(movie);
              movieCardsContainer.appendChild(card);
            });
            emptyState.style.display = 'none';
            movieCardsContainer.style.display = 'grid';
          } else {
            emptyState.style.display = 'block';
            movieCardsContainer.style.display = 'none';
          }
        } else {
          if (response.status === 401) {
            showNotification('Session expired. Please login again.', 'error');
            localStorage.removeItem('sessionId');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
          } else {
            showNotification('Failed to load movies', 'error');
            emptyState.style.display = 'block';
            movieCardsContainer.style.display = 'none';
          }
        }
      } catch (error) {
        console.error('Error loading movies:', error);
        showNotification('Failed to load movies. Please check your connection.', 'error');
        emptyState.style.display = 'block';
        movieCardsContainer.style.display = 'none';
      }
    }

    // Function to delete movie
    async function deleteMovie(movieId, event) {
      if (event) {
        event.stopPropagation();
      }
      
      if (!confirm('Are you sure you want to delete this movie from your watchlist?')) {
        return;
      }

      // Check if user is authenticated
      const sessionId = localStorage.getItem('sessionId');
      if (!sessionId) {
        showNotification('Please login to manage your watchlist', 'error');
        window.location.href = 'login.html';
        return;
      }

      try {
        const response = await fetch(`/api/movies/${movieId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${sessionId}`
          }
        });

        const result = await response.json();

        if (response.ok) {
          showNotification('Movie removed from watchlist', 'success');
          loadMovies(); // Reload the entire list
        } else {
          if (response.status === 401) {
            showNotification('Session expired. Please login again.', 'error');
            localStorage.removeItem('sessionId');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
          } else {
            showNotification(result.message || 'Failed to delete movie', 'error');
          }
        }
      } catch (error) {
        console.error('Error deleting movie:', error);
        showNotification('Failed to delete movie. Please try again.', 'error');
      }
    }

    // Function to move movie to review (opens UI)
    function moveToReview(movieId, event) {
      if (event) event.stopPropagation();
      const sessionId = localStorage.getItem('sessionId');
      if (!sessionId) {
        showNotification('Please login to move movies to reviews', 'error');
        window.location.href = 'login.html';
        return;
      }
      // Store the movie id and redirect to Reviews page to open full form
      localStorage.setItem('moveToReviewMovieId', movieId);
      window.location.href = 'reviews.html';
    }

    // Star rating interactions for Move to Review
    function setMoveRating(value) {
      moveRatingValue.value = value;
      [...moveRatingStars.querySelectorAll('.star')].forEach(star => {
        const v = parseInt(star.dataset.value, 10);
        star.classList.toggle('active', v <= value);
      });
    }
    moveRatingStars.addEventListener('click', (e) => {
      const btn = e.target.closest('.star');
      if (!btn) return;
      setMoveRating(parseInt(btn.dataset.value, 10));
    });
    moveRatingStars.addEventListener('mousemove', (e) => {
      const btn = e.target.closest('.star');
      if (!btn) return;
      const hoverVal = parseInt(btn.dataset.value, 10);
      [...moveRatingStars.querySelectorAll('.star')].forEach(star => {
        const v = parseInt(star.dataset.value, 10);
        star.classList.toggle('hover', v <= hoverVal);
      });
    });
    moveRatingStars.addEventListener('mouseleave', () => {
      [...moveRatingStars.querySelectorAll('.star')].forEach(star => star.classList.remove('hover'));
    });

    function updateMoveCounter() {
      const len = moveReviewText.value.length;
      moveReviewCounter.textContent = `${len}/500`;
      if (len > 500) moveReviewText.value = moveReviewText.value.slice(0, 500);
    }
    moveReviewText.addEventListener('input', updateMoveCounter);

    // Submit Move to Review form
    moveReviewForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const sessionId = localStorage.getItem('sessionId');
      const movieId = moveReviewMovieId.value;
      const ratingStars = parseInt(moveRatingValue.value, 10);
      const reviewText = moveReviewText.value.trim();
      try {
        const response = await fetch(`/api/movies/${movieId}/move-to-review`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${sessionId}`
          },
          body: JSON.stringify({ ratingStars, reviewText })
        });
        const result = await response.json();
        if (response.ok) {
          closeMoveToReviewModal();
          showNotification('Moved to Reviews successfully!', 'success');
          await loadMovies();
          setTimeout(() => { window.location.href = 'reviews.html'; }, 700);
        } else {
          if (response.status === 401) {
            showNotification('Session expired. Please login again.', 'error');
            localStorage.removeItem('sessionId');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
          } else {
            showNotification(result.message || 'Failed to move to reviews', 'error');
          }
        }
      } catch (err) {
        console.error('Move to review error:', err);
        showNotification('Failed to move to reviews. Please try again.', 'error');
      }
    });

    // Dynamic Genre Selector
    const genreSelector = document.getElementById('selectedGenresDisplay');
    const genreDropdown = document.getElementById('genreDropdown');

    genreSelector.addEventListener('click', () => {
      genreDropdown.classList.toggle('active');
    });

    document.addEventListener('click', (e) => {
      if (!genreSelector.contains(e.target) && !genreDropdown.contains(e.target)) {
        genreDropdown.classList.remove('active');
      }
    });

    genreDropdown.addEventListener('click', (e) => {
      if (e.target.classList.contains('genre-option')) {
        const genre = e.target.dataset.value;
        if (selectedGenres.includes(genre)) {
          selectedGenres = selectedGenres.filter(g => g !== genre);
          e.target.classList.remove('selected');
        } else {
          if (selectedGenres.length < 5) {
            selectedGenres.push(genre);
            e.target.classList.add('selected');
          } else {
            showNotification('Maximum 5 genres allowed', 'error');
          }
        }
        updateGenreDisplay();
      }
    });

    function updateGenreDisplay() {
      document.getElementById('selectedGenres').value = JSON.stringify(selectedGenres);
      if (selectedGenres.length === 0) {
        genreSelector.innerHTML = '<span class="placeholder">Click to select genres...</span>';
      } else {
        genreSelector.innerHTML = selectedGenres.map(genre => 
          `<span class="selected-tag" data-genre="${genre}">${genre}</span>`
        ).join('');
        
        // Add click handlers for removing tags
        genreSelector.querySelectorAll('.selected-tag').forEach(tag => {
          tag.addEventListener('click', (e) => {
            e.stopPropagation();
            const genreToRemove = tag.dataset.genre;
            selectedGenres = selectedGenres.filter(g => g !== genreToRemove);
            updateGenreDisplay();
            // Update dropdown selection
            document.querySelectorAll('.genre-option').forEach(option => {
              if (option.dataset.value === genreToRemove) {
                option.classList.remove('selected');
              }
            });
          });
        });
      }
    }

    // Dynamic OTT Selector
    const ottSelector = document.getElementById('selectedOTTDisplay');
    const ottDropdown = document.getElementById('ottDropdown');

    ottSelector.addEventListener('click', () => {
      ottDropdown.classList.toggle('active');
    });

    document.addEventListener('click', (e) => {
      if (!ottSelector.contains(e.target) && !ottDropdown.contains(e.target)) {
        ottDropdown.classList.remove('active');
      }
    });

    ottDropdown.addEventListener('click', (e) => {
      if (e.target.classList.contains('ott-option')) {
        const platform = e.target.dataset.value;
        
        if (selectedOTT.includes(platform)) {
          selectedOTT = selectedOTT.filter(p => p !== platform);
          e.target.classList.remove('selected');
        } else {
          selectedOTT.push(platform);
          e.target.classList.add('selected');
        }
        updateOTTDisplay();
      }
    });

    function updateOTTDisplay() {
      document.getElementById('selectedOTT').value = JSON.stringify(selectedOTT);
      if (selectedOTT.length === 0) {
        ottSelector.innerHTML = '<span class="placeholder">Click to select platforms...</span>';
      } else {
        ottSelector.innerHTML = selectedOTT.map(platform => 
          `<span class="selected-tag" data-platform="${platform}">${platform}</span>`
        ).join('');
        
        // Add click handlers for removing tags
        ottSelector.querySelectorAll('.selected-tag').forEach(tag => {
          tag.addEventListener('click', (e) => {
            e.stopPropagation();
            const platformToRemove = tag.dataset.platform;
            selectedOTT = selectedOTT.filter(p => p !== platformToRemove);
            updateOTTDisplay();
            // Update dropdown selection for predefined platforms
            document.querySelectorAll('.ott-option').forEach(option => {
              if (option.dataset.value === platformToRemove) {
                option.classList.remove('selected');
              }
            });
          });
        });
      }
    }

    // Function to show notifications
    function showNotification(message, type = 'info') {
      // Remove existing notifications
      document.querySelectorAll('.notification').forEach(n => n.remove());
      
      // Create notification element
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.textContent = message;

      // Add to page
      document.body.appendChild(notification);

      // Remove after 4 seconds
      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove();
        }
      }, 4000);
    }

    // Logout functionality
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      const sessionId = localStorage.getItem('sessionId');
      
      if (sessionId) {
        try {
          await fetch('/api/logout', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${sessionId}`
            }
          });
        } catch (error) {
          console.error('Logout error:', error);
        }
      }
      
      // Clear local storage and redirect
      localStorage.removeItem('sessionId');
      localStorage.removeItem('user');
      localStorage.removeItem('userMovies');
      showNotification('Logged out successfully', 'success');
      setTimeout(() => {
        window.location.href = 'login.html';
      }, 1000);
    });

    // Display user info
    function displayUserInfo() {
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      const userDisplay = document.getElementById('userDisplay');
      
      if (user.firstName && user.lastName) {
        userDisplay.textContent = `Welcome, ${user.firstName} ${user.lastName}!`;
      } else if (user.username) {
        userDisplay.textContent = `Welcome, ${user.username}!`;
      } else {
        userDisplay.textContent = 'Welcome!';
      }
    }

    // Add keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // ESC to close modals
      if (e.key === 'Escape') {
        if (modal.style.display === 'block') {
          closeModal();
        }
        if (detailsModal.style.display === 'block') {
          closeDetailsModal();
        }
      }
      
      // Ctrl/Cmd + N to add new movie
      if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        addMovieBtn.click();
      }
    });

    // Add loading state for better UX
    function showLoadingState() {
      movieCardsContainer.innerHTML = '<div style="text-align: center; color: white; padding: 50px; font-size: 1.2rem;">Loading your movies...</div>';
    }

    // Improve the loadMovies function to show loading state
    const originalLoadMovies = loadMovies;
    loadMovies = async function() {
      showLoadingState();
      return originalLoadMovies();
    };

    // Add smooth scrolling for better UX
    function scrollToTop() {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    }

    // Scroll to top when adding/editing movies
    addMovieBtn.addEventListener('click', scrollToTop);

    // Add form validation feedback
    function validateForm() {
      const title = document.getElementById('movieTitle').value.trim();
      const description = document.getElementById('movieDescription').value.trim();
      const releaseYear = document.getElementById('releaseYear').value;
      
      let isValid = true;
      
      // Remove previous error states
      document.querySelectorAll('.form-group input, .form-group textarea').forEach(input => {
        input.style.borderColor = '#e1e8ed';
      });
      
      if (!title) {
        document.getElementById('movieTitle').style.borderColor = '#e74c3c';
        isValid = false;
      }
      
      if (!description) {
        document.getElementById('movieDescription').style.borderColor = '#e74c3c';
        isValid = false;
      }
      
      if (!releaseYear) {
        document.getElementById('releaseYear').style.borderColor = '#e74c3c';
        isValid = false;
      }
      
      if (selectedGenres.length === 0) {
        genreSelector.style.borderColor = '#e74c3c';
        isValid = false;
      } else {
        genreSelector.style.borderColor = '#e1e8ed';
      }
      
      return isValid;
    }

    // Add real-time validation
    ['movieTitle', 'movieDescription', 'releaseYear'].forEach(id => {
      document.getElementById(id).addEventListener('input', validateForm);
    });

    // Enhance the movie card hover effect
    document.addEventListener('mouseover', (e) => {
      if (e.target.closest('.movie-card')) {
        const card = e.target.closest('.movie-card');
        card.style.transform = 'translateY(-15px) scale(1.02)';
      }
    });

    document.addEventListener('mouseout', (e) => {
      if (e.target.closest('.movie-card')) {
        const card = e.target.closest('.movie-card');
        if (!card.matches(':hover')) {
          card.style.transform = '';
        }
      }
    });

    // Add search functionality (future enhancement)
    function addSearchFunctionality() {
      // This can be implemented later for searching through movies
      const searchInput = document.createElement('input');
      searchInput.type = 'text';
      searchInput.placeholder = 'Search your movies...';
      searchInput.className = 'search-input';
      // Add to DOM when needed
    }

    // Initialize tooltips for better UX
    function initTooltips() {
      const elements = document.querySelectorAll('[title]');
      elements.forEach(element => {
        element.addEventListener('mouseenter', (e) => {
          // Custom tooltip implementation can go here
        });
      });
    }

    // Call initialization functions
    initTooltips();

    console.log('Movie Vault Watchlist loaded successfully! ðŸŽ¬');
  </script>
</body>

</html>
</html>